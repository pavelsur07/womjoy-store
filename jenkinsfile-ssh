pipeline {
    agent any
    options {
        timestamps()
    }
    environment {
        REGISTRY = credentials('REGISTRY')
        IMAGE_TAG = sh(
            returnStdout: true,
            script: "echo '${env.BUILD_TAG}' | sed 's/%2F/-/g'"
        ).trim()

    }
    stages {

        stage("ssh") {
            when {
                branch "master"
            }
            steps {
                withCredentials([
                    string(credentialsId: 'PROD_HOST', variable: 'HOST'),
                    string(credentialsId: 'PROD_PORT', variable: 'PORT'),
                    string(credentialsId: 'PROD_APP_SECRET', variable: 'APP_SECRET'),
                    string(credentialsId: 'PROD_SENTRY_DSN', variable: 'SENTRY_DSN'),
                    string(credentialsId: 'PROD_SITE_MAIL_PASSWORD', variable: 'SITE_MAIL_PASSWORD'),
                    string(credentialsId: 'PROD_DB_PASSWORD', variable: 'DB_PASSWORD'),
                    string(credentialsId: 'PROD_S3_ACCESS_ID', variable: 'SITE_S3_ACCESS_ID'),
                    string(credentialsId: 'PROD_S3_ACCESS_SECRET', variable: 'SITE_S3_SECRET'),
                    string(credentialsId: 'PROD_REDIS_PASSWORD', variable: 'REDIS_PASSWORD'),
                    string(credentialsId: 'PROD_SITE_ALFABANK_USERNAME', variable: 'SITE_ALFABANK_USERNAME'),
                    string(credentialsId: 'PROD_SITE_ALFABANK_PASSWORD', variable: 'SITE_ALFABANK_PASSWORD'),
                    string(credentialsId: 'PROD_SITE_YANDEX_PAY_API_KEY', variable: 'SITE_YANDEX_PAY_API_KEY'),
                    string(credentialsId: 'PROD_GOOGLE_RECAPTCHA_SITE_KEY', variable: 'GOOGLE_RECAPTCHA_SITE_KEY'),
                    string(credentialsId: 'PROD_GOOGLE_RECAPTCHA_SECRET', variable: 'GOOGLE_RECAPTCHA_SECRET')
                ]) {
                    sshagent (credentials: ['PROD_AUTH']) {
                        ssh-copy-id deploy@151.248.121.164
                    }
                }
            }
        }
    }
    
}
